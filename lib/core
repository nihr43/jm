#!/bin/sh

core::list () {
  local JLS=`jls name`
  for i in `ls $JM_DIR/` ; do
    echo $JLS | grep -q "^$i$" && {
      echo "$i Running"
    } || {
      echo "$i"
    }
  done
}

core::start () {
  service jail onestart $JAIL_NAME
#echo `hostname` > $JAIL_DIR/$JAIL_NAME/lock
#  jail -f $JAIL_DIR/$JAIL_NAME/jail.conf -c $JAIL_NAME
}

core::stop () {
  service jail onestop $JAIL_NAME
  #jail -f $JAIL_DIR/$JAIL_NAME/.jail.conf -r $JAIL_NAME
  #umount $JAIL_DIR/$JAIL_NAME/$JAIL_NAME/dev/fd
  #umount $JAIL_DIR/$JAIL_NAME/$JAIL_NAME/dev
  #umount $JAIL_DIR/$JAIL_NAME/$JAIL_NAME/proc
  #rm $JAIL_DIR/$JAIL_NAME/lock
}

core::restart () {
  service jail onerestart $JAIL_NAME
}

core::create () {
  local IMAGE='.12.0-RELEASE-base.txz'
  util::check_name $JAIL_NAME || exit 1

  [ -e $JM_DIR/$JAIL_NAME ] && {
    echo "$JAIL_NAME exists"
    exit 1
  }

  echo "creating $JAIL_NAME"
  mkdir $JM_DIR/$JAIL_NAME
  tar xpf $JM_DIR/$IMAGE -C $JM_DIR/$JAIL_NAME
  util::update_conf create $JAIL_NAME
}

core::delete () {
  util::check_name $JAIL_NAME || exit 1 # prevents removing silly things like "$JM_DIR/../../ " , which the following WILL evauluate as 'exists'

  [ -e $JM_DIR/$JAIL_NAME ] || {
    echo "$JAIL_NAME does not exist"
    exit 1
  }

  # if the jail is running, stop it
  jls name | grep -q "^$JAIL_NAME$" && core::stop

  echo -n "deleting $JAIL_NAME"
  chflags -R noschg $JM_DIR/$JAIL_NAME
  rm -rf $JM_DIR/$JAIL_NAME
  util::update_conf delete $JAIL_NAME
}
